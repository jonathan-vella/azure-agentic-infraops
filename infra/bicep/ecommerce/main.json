{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "8470948479721311932"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "allowedValues": [
        "swedencentral",
        "germanywestcentral",
        "westeurope",
        "northeurope"
      ],
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name"
      }
    },
    "projectName": {
      "type": "string",
      "defaultValue": "ecommerce",
      "metadata": {
        "description": "Project name used for resource naming"
      }
    },
    "owner": {
      "type": "string",
      "defaultValue": "platform-team",
      "metadata": {
        "description": "Owner team or individual"
      }
    },
    "costCenter": {
      "type": "string",
      "defaultValue": "CC-ECOM-001",
      "metadata": {
        "description": "Cost center for billing"
      }
    },
    "sqlAdminGroupObjectId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD admin group object ID for SQL Server"
      }
    },
    "sqlAdminGroupName": {
      "type": "string",
      "defaultValue": "sql-admins",
      "metadata": {
        "description": "Azure AD admin group name for SQL Server"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "regionAbbreviations": {
      "swedencentral": "swc",
      "germanywestcentral": "gwc",
      "westeurope": "weu",
      "northeurope": "neu"
    },
    "locationShort": "[variables('regionAbbreviations')[parameters('location')]]",
    "resourceNames": {
      "vnet": "[format('vnet-{0}-{1}-{2}-001', parameters('projectName'), parameters('environment'), variables('locationShort'))]",
      "nsgWeb": "[format('nsg-web-{0}-{1}-001', parameters('environment'), variables('locationShort'))]",
      "nsgData": "[format('nsg-data-{0}-{1}-001', parameters('environment'), variables('locationShort'))]",
      "nsgIntegration": "[format('nsg-integration-{0}-{1}-001', parameters('environment'), variables('locationShort'))]",
      "keyVault": "[format('kv-{0}-{1}-{2}', take(parameters('projectName'), 4), parameters('environment'), take(variables('uniqueSuffix'), 6))]",
      "appServicePlan": "[format('asp-{0}-{1}-{2}-001', parameters('projectName'), parameters('environment'), variables('locationShort'))]",
      "sqlServer": "[format('sql-{0}-{1}-{2}-{3}', parameters('projectName'), parameters('environment'), variables('locationShort'), take(variables('uniqueSuffix'), 6))]",
      "sqlDatabase": "[format('sqldb-{0}-{1}', parameters('projectName'), parameters('environment'))]",
      "redis": "[format('redis-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), take(variables('uniqueSuffix'), 6))]",
      "appService": "[format('app-{0}-api-{1}-{2}-001', parameters('projectName'), parameters('environment'), variables('locationShort'))]",
      "search": "[format('srch-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), take(variables('uniqueSuffix'), 6))]",
      "serviceBus": "[format('sb-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), take(variables('uniqueSuffix'), 6))]",
      "functionAppPlan": "[format('asp-func-{0}-{1}-{2}-001', parameters('projectName'), parameters('environment'), variables('locationShort'))]",
      "functionApp": "[format('func-{0}-orders-{1}-{2}-001', parameters('projectName'), parameters('environment'), variables('locationShort'))]",
      "logAnalytics": "[format('log-{0}-{1}-{2}-001', parameters('projectName'), parameters('environment'), variables('locationShort'))]",
      "appInsights": "[format('appi-{0}-{1}-{2}-001', parameters('projectName'), parameters('environment'), variables('locationShort'))]",
      "frontDoor": "[format('afd-{0}-{1}-001', parameters('projectName'), parameters('environment'))]",
      "wafPolicy": "[format('waf-{0}-{1}-001', parameters('projectName'), parameters('environment'))]",
      "staticWebApp": "[format('swa-{0}-{1}-{2}-001', parameters('projectName'), parameters('environment'), variables('locationShort'))]"
    },
    "tags": {
      "Environment": "[parameters('environment')]",
      "ManagedBy": "Bicep",
      "Project": "[format('{0}-platform', parameters('projectName'))]",
      "Owner": "[parameters('owner')]",
      "CostCenter": "[parameters('costCenter')]",
      "Compliance": "PCI-DSS",
      "Region": "[parameters('location')]"
    },
    "networkConfig": {
      "addressPrefix": "10.0.0.0/16",
      "subnets": {
        "web": {
          "name": "[format('snet-web-{0}', parameters('environment'))]",
          "addressPrefix": "10.0.1.0/24"
        },
        "data": {
          "name": "[format('snet-data-{0}', parameters('environment'))]",
          "addressPrefix": "10.0.2.0/24"
        },
        "integration": {
          "name": "[format('snet-integration-{0}', parameters('environment'))]",
          "addressPrefix": "10.0.3.0/24"
        }
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "nsg-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "nsgWebName": {
            "value": "[variables('resourceNames').nsgWeb]"
          },
          "nsgDataName": {
            "value": "[variables('resourceNames').nsgData]"
          },
          "nsgIntegrationName": {
            "value": "[variables('resourceNames').nsgIntegration]"
          },
          "webSubnetPrefix": {
            "value": "[variables('networkConfig').subnets.web.addressPrefix]"
          },
          "dataSubnetPrefix": {
            "value": "[variables('networkConfig').subnets.data.addressPrefix]"
          },
          "integrationSubnetPrefix": {
            "value": "[variables('networkConfig').subnets.integration.addressPrefix]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8218538161187327173"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for NSG deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "nsgWebName": {
              "type": "string",
              "metadata": {
                "description": "Name of the web tier NSG"
              }
            },
            "nsgDataName": {
              "type": "string",
              "metadata": {
                "description": "Name of the data tier NSG"
              }
            },
            "nsgIntegrationName": {
              "type": "string",
              "metadata": {
                "description": "Name of the integration tier NSG"
              }
            },
            "webSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "Web subnet address prefix"
              }
            },
            "dataSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "Data subnet address prefix"
              }
            },
            "integrationSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "Integration subnet address prefix"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[parameters('nsgWebName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowFrontDoorHTTPS",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "AzureFrontDoor.Backend",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "[parameters('webSubnetPrefix')]",
                      "destinationPortRange": "443",
                      "description": "Allow HTTPS traffic from Azure Front Door"
                    }
                  },
                  {
                    "name": "AllowHealthProbes",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "[parameters('webSubnetPrefix')]",
                      "destinationPortRange": "*",
                      "description": "Allow Azure health probes"
                    }
                  },
                  {
                    "name": "AllowVNetInbound",
                    "properties": {
                      "priority": 200,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*",
                      "description": "Allow VNet internal communication"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "description": "Deny all other inbound traffic"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[parameters('nsgDataName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowWebSubnetInbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "[parameters('webSubnetPrefix')]",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "[parameters('dataSubnetPrefix')]",
                      "destinationPortRange": "*",
                      "description": "Allow traffic from web tier"
                    }
                  },
                  {
                    "name": "AllowIntegrationSubnetInbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "[parameters('integrationSubnetPrefix')]",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "[parameters('dataSubnetPrefix')]",
                      "destinationPortRange": "*",
                      "description": "Allow traffic from integration tier"
                    }
                  },
                  {
                    "name": "AllowAzureServicesInbound",
                    "properties": {
                      "priority": 200,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "AzureCloud",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "[parameters('dataSubnetPrefix')]",
                      "destinationPortRange": "*",
                      "description": "Allow Azure services for private endpoints"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "description": "Deny all other inbound traffic"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[parameters('nsgIntegrationName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowWebSubnetInbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "[parameters('webSubnetPrefix')]",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "[parameters('integrationSubnetPrefix')]",
                      "destinationPortRange": "*",
                      "description": "Allow traffic from web tier"
                    }
                  },
                  {
                    "name": "AllowDataSubnetInbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "[parameters('dataSubnetPrefix')]",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "[parameters('integrationSubnetPrefix')]",
                      "destinationPortRange": "*",
                      "description": "Allow traffic from data tier"
                    }
                  },
                  {
                    "name": "AllowAzureServicesInbound",
                    "properties": {
                      "priority": 200,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "AzureCloud",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "[parameters('integrationSubnetPrefix')]",
                      "destinationPortRange": "*",
                      "description": "Allow Azure services for Service Bus"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "description": "Deny all other inbound traffic"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "nsgWebId": {
              "type": "string",
              "metadata": {
                "description": "Web tier NSG resource ID"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgWebName'))]"
            },
            "nsgDataId": {
              "type": "string",
              "metadata": {
                "description": "Data tier NSG resource ID"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgDataName'))]"
            },
            "nsgIntegrationId": {
              "type": "string",
              "metadata": {
                "description": "Integration tier NSG resource ID"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgIntegrationName'))]"
            },
            "nsgWebName": {
              "type": "string",
              "metadata": {
                "description": "Web tier NSG name"
              },
              "value": "[parameters('nsgWebName')]"
            },
            "nsgDataName": {
              "type": "string",
              "metadata": {
                "description": "Data tier NSG name"
              },
              "value": "[parameters('nsgDataName')]"
            },
            "nsgIntegrationName": {
              "type": "string",
              "metadata": {
                "description": "Integration tier NSG name"
              },
              "value": "[parameters('nsgIntegrationName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "vnetName": {
            "value": "[variables('resourceNames').vnet]"
          },
          "addressPrefix": {
            "value": "[variables('networkConfig').addressPrefix]"
          },
          "subnets": {
            "value": [
              {
                "name": "[variables('networkConfig').subnets.web.name]",
                "addressPrefix": "[variables('networkConfig').subnets.web.addressPrefix]",
                "nsgId": "[reference(resourceId('Microsoft.Resources/deployments', 'nsg-deployment'), '2025-04-01').outputs.nsgWebId.value]",
                "serviceEndpoints": [
                  {
                    "service": "Microsoft.Web"
                  }
                ],
                "delegations": [
                  {
                    "name": "Microsoft.Web.serverFarms",
                    "properties": {
                      "serviceName": "Microsoft.Web/serverFarms"
                    }
                  }
                ]
              },
              {
                "name": "[variables('networkConfig').subnets.data.name]",
                "addressPrefix": "[variables('networkConfig').subnets.data.addressPrefix]",
                "nsgId": "[reference(resourceId('Microsoft.Resources/deployments', 'nsg-deployment'), '2025-04-01').outputs.nsgDataId.value]",
                "serviceEndpoints": [
                  {
                    "service": "Microsoft.Sql"
                  },
                  {
                    "service": "Microsoft.Storage"
                  },
                  {
                    "service": "Microsoft.KeyVault"
                  }
                ],
                "delegations": []
              },
              {
                "name": "[variables('networkConfig').subnets.integration.name]",
                "addressPrefix": "[variables('networkConfig').subnets.integration.addressPrefix]",
                "nsgId": "[reference(resourceId('Microsoft.Resources/deployments', 'nsg-deployment'), '2025-04-01').outputs.nsgIntegrationId.value]",
                "serviceEndpoints": [
                  {
                    "service": "Microsoft.ServiceBus"
                  }
                ],
                "delegations": [
                  {
                    "name": "Microsoft.Web.serverFarms",
                    "properties": {
                      "serviceName": "Microsoft.Web/serverFarms"
                    }
                  }
                ]
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16354160488631617985"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for VNet deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the virtual network"
              }
            },
            "addressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Address prefix for the VNet"
              }
            },
            "subnets": {
              "type": "array",
              "metadata": {
                "description": "Subnet configurations"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "copy": [
                  {
                    "name": "subnets",
                    "count": "[length(parameters('subnets'))]",
                    "input": {
                      "name": "[parameters('subnets')[copyIndex('subnets')].name]",
                      "properties": {
                        "addressPrefix": "[parameters('subnets')[copyIndex('subnets')].addressPrefix]",
                        "networkSecurityGroup": "[if(not(equals(parameters('subnets')[copyIndex('subnets')].nsgId, '')), createObject('id', parameters('subnets')[copyIndex('subnets')].nsgId), null())]",
                        "serviceEndpoints": "[parameters('subnets')[copyIndex('subnets')].serviceEndpoints]",
                        "delegations": "[parameters('subnets')[copyIndex('subnets')].delegations]",
                        "privateEndpointNetworkPolicies": "Disabled",
                        "privateLinkServiceNetworkPolicies": "Enabled"
                      }
                    }
                  }
                ],
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('addressPrefix')]"
                  ]
                },
                "enableDdosProtection": false
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Virtual network resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Virtual network name"
              },
              "value": "[parameters('vnetName')]"
            },
            "webSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Web subnet resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnets')[0].name)]"
            },
            "dataSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Data subnet resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnets')[1].name)]"
            },
            "integrationSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Integration subnet resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnets')[2].name)]"
            },
            "subnetIds": {
              "type": "object",
              "metadata": {
                "description": "All subnet resource IDs"
              },
              "value": {
                "web": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnets')[0].name)]",
                "data": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnets')[1].name)]",
                "integration": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnets')[2].name)]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'nsg-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "private-dns-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "tags": {
            "value": "[variables('tags')]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "vnetName": {
            "value": "[variables('resourceNames').vnet]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15858265392775031165"
            }
          },
          "parameters": {
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "VNet resource ID for linking"
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "VNet name for link naming"
              }
            }
          },
          "variables": {
            "dnsZones": [
              "privatelink.vaultcore.azure.net",
              "privatelink.database.windows.net",
              "privatelink.redis.cache.windows.net",
              "privatelink.search.windows.net",
              "privatelink.servicebus.windows.net"
            ]
          },
          "resources": [
            {
              "copy": {
                "name": "privateDnsZones",
                "count": "[length(variables('dnsZones'))]"
              },
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[variables('dnsZones')[copyIndex()]]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "copy": {
                "name": "vnetLinks",
                "count": "[length(variables('dnsZones'))]"
              },
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', variables('dnsZones')[copyIndex()], format('{0}-link', parameters('vnetName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('dnsZones')[copyIndex()])]"
              ]
            }
          ],
          "outputs": {
            "keyVaultDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault private DNS zone ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('dnsZones')[0])]"
            },
            "sqlDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "SQL private DNS zone ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('dnsZones')[1])]"
            },
            "redisDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Redis private DNS zone ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('dnsZones')[2])]"
            },
            "searchDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Search private DNS zone ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('dnsZones')[3])]"
            },
            "serviceBusDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Service Bus private DNS zone ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('dnsZones')[4])]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "key-vault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "keyVaultName": {
            "value": "[variables('resourceNames').keyVault]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.dataSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'private-dns-deployment'), '2025-04-01').outputs.keyVaultDnsZoneId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14035360753471271100"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Key Vault deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "keyVaultName": {
              "type": "string",
              "maxLength": 24,
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for private endpoint"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone ID for Key Vault"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enablePurgeProtection": true,
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": false,
                "publicNetworkAccess": "Disabled",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Deny",
                  "ipRules": [],
                  "virtualNetworkRules": []
                }
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('pe-{0}', parameters('keyVaultName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pe-{0}-connection', parameters('keyVaultName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('keyVaultName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-vaultcore-azure-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('keyVaultName')))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              },
              "value": "[parameters('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'private-dns-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "app-service-plan-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appServicePlanName": {
            "value": "[variables('resourceNames').appServicePlan]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17824228726316885866"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for App Service Plan deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service Plan"
              }
            },
            "capacity": {
              "type": "int",
              "defaultValue": 2,
              "minValue": 2,
              "maxValue": 10,
              "metadata": {
                "description": "Number of worker instances"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "linux",
              "sku": {
                "name": "P1v3",
                "tier": "PremiumV3",
                "size": "P1v3",
                "capacity": "[parameters('capacity')]"
              },
              "properties": {
                "reserved": true,
                "zoneRedundant": true,
                "targetWorkerCount": "[parameters('capacity')]",
                "targetWorkerSizeId": 0
              }
            }
          ],
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              },
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
            },
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan name"
              },
              "value": "[parameters('appServicePlanName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sql-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sqlServerName": {
            "value": "[variables('resourceNames').sqlServer]"
          },
          "sqlDatabaseName": {
            "value": "[variables('resourceNames').sqlDatabase]"
          },
          "adminGroupObjectId": {
            "value": "[parameters('sqlAdminGroupObjectId')]"
          },
          "adminGroupName": {
            "value": "[parameters('sqlAdminGroupName')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.dataSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'private-dns-deployment'), '2025-04-01').outputs.sqlDnsZoneId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13900620587942803602"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for SQL deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "Name of the SQL Server"
              }
            },
            "sqlDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "Name of the SQL Database"
              }
            },
            "adminGroupObjectId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD admin group object ID"
              }
            },
            "adminGroupName": {
              "type": "string",
              "metadata": {
                "description": "Azure AD admin group name"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for private endpoint"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone ID for SQL"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-08-01-preview",
              "name": "[parameters('sqlServerName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "version": "12.0",
                "minimalTlsVersion": "1.2",
                "publicNetworkAccess": "Disabled",
                "administrators": {
                  "administratorType": "ActiveDirectory",
                  "principalType": "Group",
                  "login": "[parameters('adminGroupName')]",
                  "sid": "[parameters('adminGroupObjectId')]",
                  "tenantId": "[subscription().tenantId]",
                  "azureADOnlyAuthentication": true
                }
              }
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-08-01-preview",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), parameters('sqlDatabaseName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "S3",
                "tier": "Standard",
                "capacity": 100
              },
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": 268435456000,
                "catalogCollation": "SQL_Latin1_General_CP1_CI_AS",
                "zoneRedundant": false,
                "readScale": "Disabled",
                "requestedBackupStorageRedundancy": "Geo"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
              "apiVersion": "2023-08-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('sqlServerName'), parameters('sqlDatabaseName'), 'current')]",
              "properties": {
                "state": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('sqlDatabaseName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/auditingSettings",
              "apiVersion": "2023-08-01-preview",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), 'default')]",
              "properties": {
                "state": "Enabled",
                "isAzureMonitorTargetEnabled": true,
                "retentionDays": 90
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('pe-{0}', parameters('sqlServerName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pe-{0}-connection', parameters('sqlServerName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]",
                      "groupIds": [
                        "sqlServer"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('sqlServerName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-database-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('sqlServerName')))]"
              ]
            }
          ],
          "outputs": {
            "sqlServerId": {
              "type": "string",
              "metadata": {
                "description": "SQL Server resource ID"
              },
              "value": "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
            },
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name"
              },
              "value": "[parameters('sqlServerName')]"
            },
            "sqlServerFqdn": {
              "type": "string",
              "metadata": {
                "description": "SQL Server FQDN"
              },
              "value": "[reference(resourceId('Microsoft.Sql/servers', parameters('sqlServerName')), '2023-08-01-preview').fullyQualifiedDomainName]"
            },
            "sqlDatabaseId": {
              "type": "string",
              "metadata": {
                "description": "SQL Database resource ID"
              },
              "value": "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('sqlDatabaseName'))]"
            },
            "sqlDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "SQL Database name"
              },
              "value": "[parameters('sqlDatabaseName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'private-dns-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "redis-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "redisName": {
            "value": "[variables('resourceNames').redis]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.dataSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'private-dns-deployment'), '2025-04-01').outputs.redisDnsZoneId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "152959494223254315"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Redis deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "redisName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Redis Cache"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for private endpoint"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone ID for Redis"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Cache/redis",
              "apiVersion": "2024-03-01",
              "name": "[parameters('redisName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "Standard",
                  "family": "C",
                  "capacity": 2
                },
                "enableNonSslPort": false,
                "minimumTlsVersion": "1.2",
                "publicNetworkAccess": "Disabled",
                "redisConfiguration": {
                  "maxmemory-policy": "volatile-lru",
                  "maxmemory-reserved": "50"
                }
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('pe-{0}', parameters('redisName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pe-{0}-connection', parameters('redisName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Cache/redis', parameters('redisName'))]",
                      "groupIds": [
                        "redisCache"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cache/redis', parameters('redisName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('redisName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-redis-cache-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('redisName')))]"
              ]
            }
          ],
          "outputs": {
            "redisCacheId": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache resource ID"
              },
              "value": "[resourceId('Microsoft.Cache/redis', parameters('redisName'))]"
            },
            "redisCacheName": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache name"
              },
              "value": "[parameters('redisName')]"
            },
            "redisHostName": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache hostname"
              },
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('redisName')), '2024-03-01').hostName]"
            },
            "redisSslPort": {
              "type": "int",
              "metadata": {
                "description": "Redis Cache SSL port"
              },
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('redisName')), '2024-03-01').sslPort]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'private-dns-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "search-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "searchServiceName": {
            "value": "[variables('resourceNames').search]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.dataSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'private-dns-deployment'), '2025-04-01').outputs.searchDnsZoneId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13454760762584290253"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Search deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "searchServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Search service"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for private endpoint"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone ID for Search"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2024-03-01-preview",
              "name": "[parameters('searchServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "standard"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "replicaCount": 1,
                "partitionCount": 1,
                "hostingMode": "default",
                "publicNetworkAccess": "disabled",
                "networkRuleSet": {
                  "ipRules": []
                },
                "encryptionWithCmk": {
                  "enforcement": "Unspecified"
                },
                "disableLocalAuth": false,
                "authOptions": {
                  "aadOrApiKey": {
                    "aadAuthFailureMode": "http403"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('pe-{0}', parameters('searchServiceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pe-{0}-connection', parameters('searchServiceName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Search/searchServices', parameters('searchServiceName'))]",
                      "groupIds": [
                        "searchService"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('searchServiceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('searchServiceName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-search-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('searchServiceName')))]"
              ]
            }
          ],
          "outputs": {
            "searchServiceId": {
              "type": "string",
              "metadata": {
                "description": "Search service resource ID"
              },
              "value": "[resourceId('Microsoft.Search/searchServices', parameters('searchServiceName'))]"
            },
            "searchServiceName": {
              "type": "string",
              "metadata": {
                "description": "Search service name"
              },
              "value": "[parameters('searchServiceName')]"
            },
            "searchServicePrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Search service principal ID"
              },
              "value": "[reference(resourceId('Microsoft.Search/searchServices', parameters('searchServiceName')), '2024-03-01-preview', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'private-dns-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "service-bus-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "serviceBusName": {
            "value": "[variables('resourceNames').serviceBus]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.integrationSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'private-dns-deployment'), '2025-04-01').outputs.serviceBusDnsZoneId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16380908526413650521"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Service Bus deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "serviceBusName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Service Bus namespace"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for private endpoint"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone ID for Service Bus"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2024-01-01",
              "name": "[parameters('serviceBusName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Premium",
                "tier": "Premium",
                "capacity": 1
              },
              "properties": {
                "zoneRedundant": true,
                "publicNetworkAccess": "Disabled",
                "disableLocalAuth": false,
                "minimumTlsVersion": "1.2"
              }
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', parameters('serviceBusName'), 'orders')]",
              "properties": {
                "maxSizeInMegabytes": 5120,
                "requiresDuplicateDetection": true,
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "requiresSession": false,
                "deadLetteringOnMessageExpiration": true,
                "maxDeliveryCount": 10,
                "enablePartitioning": false,
                "enableBatchedOperations": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('pe-{0}', parameters('serviceBusName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pe-{0}-connection', parameters('serviceBusName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]",
                      "groupIds": [
                        "namespace"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('serviceBusName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-servicebus-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('serviceBusName')))]"
              ]
            }
          ],
          "outputs": {
            "serviceBusId": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace resource ID"
              },
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
            },
            "serviceBusName": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              },
              "value": "[parameters('serviceBusName')]"
            },
            "serviceBusNamespace": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace FQDN"
              },
              "value": "[format('{0}.servicebus.windows.net', parameters('serviceBusName'))]"
            },
            "ordersQueueName": {
              "type": "string",
              "metadata": {
                "description": "Orders queue name"
              },
              "value": "orders"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'private-dns-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "app-service-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appServiceName": {
            "value": "[variables('resourceNames').appService]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-service-plan-deployment'), '2025-04-01').outputs.appServicePlanId.value]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.webSubnetId.value]"
          },
          "keyVaultUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.keyVaultUri.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12306090700856955172"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for App Service deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "appServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Service"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan resource ID"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for VNet integration"
              }
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI for configuration"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('appServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "app,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "virtualNetworkSubnetId": "[parameters('subnetId')]",
                "vnetRouteAllEnabled": true,
                "vnetContentShareEnabled": false,
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|8.0",
                  "alwaysOn": true,
                  "http20Enabled": true,
                  "minTlsVersion": "1.2",
                  "ftpsState": "Disabled",
                  "vnetRouteAllEnabled": true,
                  "ipSecurityRestrictionsDefaultAction": "Allow",
                  "scmIpSecurityRestrictionsDefaultAction": "Deny",
                  "healthCheckPath": "/health",
                  "appSettings": [
                    {
                      "name": "ASPNETCORE_ENVIRONMENT",
                      "value": "Production"
                    },
                    {
                      "name": "KeyVaultUri",
                      "value": "[parameters('keyVaultUri')]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    }
                  ]
                },
                "clientAffinityEnabled": false,
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2023-12-01",
              "name": "[format('{0}/{1}', parameters('appServiceName'), 'logs')]",
              "properties": {
                "httpLogs": {
                  "fileSystem": {
                    "enabled": true,
                    "retentionInDays": 7,
                    "retentionInMb": 35
                  }
                },
                "applicationLogs": {
                  "fileSystem": {
                    "level": "Warning"
                  }
                },
                "detailedErrorMessages": {
                  "enabled": true
                },
                "failedRequestsTracing": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appServiceName'))]"
              ]
            }
          ],
          "outputs": {
            "appServiceId": {
              "type": "string",
              "metadata": {
                "description": "App Service resource ID"
              },
              "value": "[resourceId('Microsoft.Web/sites', parameters('appServiceName'))]"
            },
            "appServiceName": {
              "type": "string",
              "metadata": {
                "description": "App Service name"
              },
              "value": "[parameters('appServiceName')]"
            },
            "defaultHostName": {
              "type": "string",
              "metadata": {
                "description": "App Service default hostname"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('appServiceName')), '2023-12-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "App Service managed identity principal ID"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('appServiceName')), '2023-12-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'app-service-plan-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functions-plan-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "functionAppPlanName": {
            "value": "[variables('resourceNames').functionAppPlan]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10266660756948690218"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Functions plan deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "functionAppPlanName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Functions App Service Plan"
              }
            },
            "maximumElasticWorkerCount": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "maxValue": 20,
              "metadata": {
                "description": "Maximum elastic worker count"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[parameters('functionAppPlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "elastic",
              "sku": {
                "name": "EP1",
                "tier": "ElasticPremium",
                "size": "EP1",
                "family": "EP",
                "capacity": 1
              },
              "properties": {
                "reserved": true,
                "maximumElasticWorkerCount": "[parameters('maximumElasticWorkerCount')]",
                "zoneRedundant": false,
                "targetWorkerCount": 0,
                "targetWorkerSizeId": 0
              }
            }
          ],
          "outputs": {
            "functionAppPlanId": {
              "type": "string",
              "metadata": {
                "description": "Functions App Service Plan resource ID"
              },
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('functionAppPlanName'))]"
            },
            "functionAppPlanName": {
              "type": "string",
              "metadata": {
                "description": "Functions App Service Plan name"
              },
              "value": "[parameters('functionAppPlanName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functions-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "functionAppName": {
            "value": "[variables('resourceNames').functionApp]"
          },
          "functionAppPlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functions-plan-deployment'), '2025-04-01').outputs.functionAppPlanId.value]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.integrationSubnetId.value]"
          },
          "keyVaultUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.keyVaultUri.value]"
          },
          "serviceBusNamespace": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'service-bus-deployment'), '2025-04-01').outputs.serviceBusNamespace.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8351417327713431855"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Functions deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Function App"
              }
            },
            "functionAppPlanId": {
              "type": "string",
              "metadata": {
                "description": "Function App Plan resource ID"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for VNet integration"
              }
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI for configuration"
              }
            },
            "serviceBusNamespace": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace FQDN"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              }
            }
          },
          "variables": {
            "storageAccountName": "[format('st{0}{1}', take(replace(parameters('functionAppName'), '-', ''), 18), take(uniqueString(resourceGroup().id), 4))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[take(variables('storageAccountName'), 24)]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('functionAppPlanId')]",
                "httpsOnly": true,
                "virtualNetworkSubnetId": "[parameters('subnetId')]",
                "vnetRouteAllEnabled": true,
                "vnetContentShareEnabled": false,
                "siteConfig": {
                  "linuxFxVersion": "DOTNET-ISOLATED|8.0",
                  "alwaysOn": true,
                  "http20Enabled": true,
                  "minTlsVersion": "1.2",
                  "ftpsState": "Disabled",
                  "vnetRouteAllEnabled": true,
                  "functionsRuntimeScaleMonitoringEnabled": true,
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', take(variables('storageAccountName'), 24), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24)), '2023-05-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', take(variables('storageAccountName'), 24), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24)), '2023-05-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(parameters('functionAppName'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "dotnet-isolated"
                    },
                    {
                      "name": "KeyVaultUri",
                      "value": "[parameters('keyVaultUri')]"
                    },
                    {
                      "name": "ServiceBusConnection__fullyQualifiedNamespace",
                      "value": "[parameters('serviceBusNamespace')]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    }
                  ]
                },
                "clientAffinityEnabled": false,
                "publicNetworkAccess": "Disabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', take(variables('storageAccountName'), 24))]"
              ]
            }
          ],
          "outputs": {
            "functionAppId": {
              "type": "string",
              "metadata": {
                "description": "Function App resource ID"
              },
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              },
              "value": "[parameters('functionAppName')]"
            },
            "defaultHostName": {
              "type": "string",
              "metadata": {
                "description": "Function App default hostname"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-12-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Function App managed identity principal ID"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-12-01', 'full').identity.principalId]"
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              },
              "value": "[take(variables('storageAccountName'), 24)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functions-plan-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'service-bus-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('resourceNames').keyVault]"
          },
          "appServicePrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-service-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "functionAppPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functions-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "serviceBusName": {
            "value": "[variables('resourceNames').serviceBus]"
          },
          "searchServiceName": {
            "value": "[variables('resourceNames').search]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8685159396970154469"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "appServicePrincipalId": {
              "type": "string",
              "metadata": {
                "description": "App Service managed identity principal ID"
              }
            },
            "functionAppPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Function App managed identity principal ID"
              }
            },
            "serviceBusName": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              }
            },
            "searchServiceName": {
              "type": "string",
              "metadata": {
                "description": "Search service name"
              }
            }
          },
          "variables": {
            "roleDefinitions": {
              "keyVaultSecretsUser": "4633458b-17de-408a-b874-0445c86b69e6",
              "serviceBusDataSender": "69a216fc-b8fb-44d8-bc22-1f3c2cd27a39",
              "serviceBusDataReceiver": "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0",
              "searchIndexDataReader": "1407120a-92aa-4202-b7e9-c0e197c71c8f"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('appServicePrincipalId'), variables('roleDefinitions').keyVaultSecretsUser)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').keyVaultSecretsUser)]",
                "principalId": "[parameters('appServicePrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('functionAppPrincipalId'), variables('roleDefinitions').keyVaultSecretsUser)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').keyVaultSecretsUser)]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ServiceBus/namespaces/{0}', parameters('serviceBusName'))]",
              "name": "[guid(resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName')), parameters('appServicePrincipalId'), variables('roleDefinitions').serviceBusDataSender)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').serviceBusDataSender)]",
                "principalId": "[parameters('appServicePrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ServiceBus/namespaces/{0}', parameters('serviceBusName'))]",
              "name": "[guid(resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName')), parameters('functionAppPrincipalId'), variables('roleDefinitions').serviceBusDataReceiver)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').serviceBusDataReceiver)]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('searchServiceName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('searchServiceName')), parameters('appServicePrincipalId'), variables('roleDefinitions').searchIndexDataReader)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').searchIndexDataReader)]",
                "principalId": "[parameters('appServicePrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-service-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functions-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'search-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "log-analytics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "workspaceName": {
            "value": "[variables('resourceNames').logAnalytics]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9175851544322693317"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Log Analytics deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics workspace"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Data retention in days (90 days for PCI-DSS)"
              }
            },
            "dailyQuotaGb": {
              "type": "int",
              "defaultValue": 5,
              "minValue": -1,
              "maxValue": 100,
              "metadata": {
                "description": "Daily ingestion cap in GB"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "workspaceCapping": {
                  "dailyQuotaGb": "[parameters('dailyQuotaGb')]"
                },
                "features": {
                  "enableDataExport": true,
                  "immediatePurgeDataOn30Days": false,
                  "disableLocalAuth": false
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace name"
              },
              "value": "[parameters('workspaceName')]"
            },
            "customerId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace customer ID (for agents)"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2023-09-01').customerId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "app-insights-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appInsightsName": {
            "value": "[variables('resourceNames').appInsights]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15436692357119097103"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Application Insights deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Application Insights resource"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Data retention in days"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                "RetentionInDays": "[parameters('retentionInDays')]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "DisableIpMasking": false,
                "DisableLocalAuth": false,
                "ForceCustomerStorageForProfiler": false
              }
            }
          ],
          "outputs": {
            "appInsightsId": {
              "type": "string",
              "metadata": {
                "description": "Application Insights resource ID"
              },
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            },
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              },
              "value": "[parameters('appInsightsName')]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "instrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key (legacy)"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "waf-policy-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "tags": {
            "value": "[variables('tags')]"
          },
          "wafPolicyName": {
            "value": "[variables('resourceNames').wafPolicy]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9625940741628930503"
            }
          },
          "parameters": {
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "wafPolicyName": {
              "type": "string",
              "metadata": {
                "description": "Name of the WAF policy"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/FrontDoorWebApplicationFirewallPolicies",
              "apiVersion": "2024-02-01",
              "name": "[parameters('wafPolicyName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_AzureFrontDoor"
              },
              "properties": {
                "policySettings": {
                  "enabledState": "Enabled",
                  "mode": "Prevention",
                  "requestBodyCheck": "Enabled",
                  "customBlockResponseStatusCode": 403,
                  "customBlockResponseBody": "[base64('{\"error\": \"Request blocked by WAF policy\"}')]"
                },
                "managedRules": {
                  "managedRuleSets": [
                    {
                      "ruleSetType": "Microsoft_DefaultRuleSet",
                      "ruleSetVersion": "2.1",
                      "ruleSetAction": "Block"
                    },
                    {
                      "ruleSetType": "Microsoft_BotManagerRuleSet",
                      "ruleSetVersion": "1.1"
                    }
                  ]
                },
                "customRules": {
                  "rules": [
                    {
                      "name": "RateLimitRule",
                      "priority": 100,
                      "enabledState": "Enabled",
                      "ruleType": "RateLimitRule",
                      "rateLimitDurationInMinutes": 1,
                      "rateLimitThreshold": 1000,
                      "matchConditions": [
                        {
                          "matchVariable": "RemoteAddr",
                          "operator": "IPMatch",
                          "negateCondition": true,
                          "matchValue": [
                            "10.0.0.0/8"
                          ]
                        }
                      ],
                      "action": "Block"
                    },
                    {
                      "name": "BlockBadBots",
                      "priority": 200,
                      "enabledState": "Enabled",
                      "ruleType": "MatchRule",
                      "matchConditions": [
                        {
                          "matchVariable": "RequestHeader",
                          "selector": "User-Agent",
                          "operator": "Contains",
                          "negateCondition": false,
                          "matchValue": [
                            "sqlmap",
                            "nikto",
                            "nmap",
                            "masscan"
                          ],
                          "transforms": [
                            "Lowercase"
                          ]
                        }
                      ],
                      "action": "Block"
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "wafPolicyId": {
              "type": "string",
              "metadata": {
                "description": "WAF policy resource ID"
              },
              "value": "[resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', parameters('wafPolicyName'))]"
            },
            "wafPolicyName": {
              "type": "string",
              "metadata": {
                "description": "WAF policy name"
              },
              "value": "[parameters('wafPolicyName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "front-door-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "tags": {
            "value": "[variables('tags')]"
          },
          "frontDoorName": {
            "value": "[variables('resourceNames').frontDoor]"
          },
          "wafPolicyId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'waf-policy-deployment'), '2025-04-01').outputs.wafPolicyId.value]"
          },
          "appServiceHostName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-service-deployment'), '2025-04-01').outputs.defaultHostName.value]"
          },
          "staticWebAppHostName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'static-web-app-deployment'), '2025-04-01').outputs.defaultHostName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1627983496396314265"
            }
          },
          "parameters": {
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "frontDoorName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Front Door profile"
              }
            },
            "wafPolicyId": {
              "type": "string",
              "metadata": {
                "description": "WAF policy resource ID"
              }
            },
            "appServiceHostName": {
              "type": "string",
              "metadata": {
                "description": "App Service hostname"
              }
            },
            "staticWebAppHostName": {
              "type": "string",
              "metadata": {
                "description": "Static Web App hostname"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Cdn/profiles",
              "apiVersion": "2024-02-01",
              "name": "[parameters('frontDoorName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_AzureFrontDoor"
              },
              "properties": {
                "originResponseTimeoutSeconds": 60
              }
            },
            {
              "type": "Microsoft.Cdn/profiles/afdEndpoints",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', parameters('frontDoorName'), 'ecommerce-endpoint')]",
              "location": "global",
              "properties": {
                "enabledState": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles', parameters('frontDoorName'))]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/originGroups",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', parameters('frontDoorName'), 'api-origin-group')]",
              "properties": {
                "loadBalancingSettings": {
                  "sampleSize": 4,
                  "successfulSamplesRequired": 3,
                  "additionalLatencyInMilliseconds": 50
                },
                "healthProbeSettings": {
                  "probePath": "/health",
                  "probeRequestType": "HEAD",
                  "probeProtocol": "Https",
                  "probeIntervalInSeconds": 30
                },
                "sessionAffinityState": "Disabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles', parameters('frontDoorName'))]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/originGroups",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', parameters('frontDoorName'), 'spa-origin-group')]",
              "properties": {
                "loadBalancingSettings": {
                  "sampleSize": 4,
                  "successfulSamplesRequired": 3,
                  "additionalLatencyInMilliseconds": 50
                },
                "healthProbeSettings": {
                  "probePath": "/",
                  "probeRequestType": "HEAD",
                  "probeProtocol": "Https",
                  "probeIntervalInSeconds": 60
                },
                "sessionAffinityState": "Disabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles', parameters('frontDoorName'))]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/originGroups/origins",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}/{2}', parameters('frontDoorName'), 'api-origin-group', 'api-origin')]",
              "properties": {
                "hostName": "[parameters('appServiceHostName')]",
                "httpPort": 80,
                "httpsPort": 443,
                "originHostHeader": "[parameters('appServiceHostName')]",
                "priority": 1,
                "weight": 1000,
                "enabledState": "Enabled",
                "enforceCertificateNameCheck": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('frontDoorName'), 'api-origin-group')]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/originGroups/origins",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}/{2}', parameters('frontDoorName'), 'spa-origin-group', 'spa-origin')]",
              "properties": {
                "hostName": "[parameters('staticWebAppHostName')]",
                "httpPort": 80,
                "httpsPort": 443,
                "originHostHeader": "[parameters('staticWebAppHostName')]",
                "priority": 1,
                "weight": 1000,
                "enabledState": "Enabled",
                "enforceCertificateNameCheck": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('frontDoorName'), 'spa-origin-group')]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}/{2}', parameters('frontDoorName'), 'ecommerce-endpoint', 'api-route')]",
              "properties": {
                "originGroup": {
                  "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('frontDoorName'), 'api-origin-group')]"
                },
                "supportedProtocols": [
                  "Https"
                ],
                "patternsToMatch": [
                  "/api/*"
                ],
                "forwardingProtocol": "HttpsOnly",
                "linkToDefaultDomain": "Enabled",
                "httpsRedirect": "Enabled",
                "enabledState": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', parameters('frontDoorName'), 'api-origin-group', 'api-origin')]",
                "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('frontDoorName'), 'api-origin-group')]",
                "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('frontDoorName'), 'ecommerce-endpoint')]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}/{2}', parameters('frontDoorName'), 'ecommerce-endpoint', 'spa-route')]",
              "properties": {
                "originGroup": {
                  "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('frontDoorName'), 'spa-origin-group')]"
                },
                "supportedProtocols": [
                  "Https"
                ],
                "patternsToMatch": [
                  "/*"
                ],
                "forwardingProtocol": "HttpsOnly",
                "linkToDefaultDomain": "Enabled",
                "httpsRedirect": "Enabled",
                "enabledState": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles/afdEndpoints/routes', parameters('frontDoorName'), 'ecommerce-endpoint', 'api-route')]",
                "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('frontDoorName'), 'ecommerce-endpoint')]",
                "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', parameters('frontDoorName'), 'spa-origin-group', 'spa-origin')]",
                "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('frontDoorName'), 'spa-origin-group')]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/securityPolicies",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', parameters('frontDoorName'), 'waf-security-policy')]",
              "properties": {
                "parameters": {
                  "type": "WebApplicationFirewall",
                  "wafPolicy": {
                    "id": "[parameters('wafPolicyId')]"
                  },
                  "associations": [
                    {
                      "domains": [
                        {
                          "id": "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('frontDoorName'), 'ecommerce-endpoint')]"
                        }
                      ],
                      "patternsToMatch": [
                        "/*"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('frontDoorName'), 'ecommerce-endpoint')]",
                "[resourceId('Microsoft.Cdn/profiles', parameters('frontDoorName'))]"
              ]
            }
          ],
          "outputs": {
            "frontDoorId": {
              "type": "string",
              "metadata": {
                "description": "Front Door profile resource ID"
              },
              "value": "[resourceId('Microsoft.Cdn/profiles', parameters('frontDoorName'))]"
            },
            "frontDoorName": {
              "type": "string",
              "metadata": {
                "description": "Front Door profile name"
              },
              "value": "[parameters('frontDoorName')]"
            },
            "endpointHostName": {
              "type": "string",
              "metadata": {
                "description": "Front Door endpoint hostname"
              },
              "value": "[reference(resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('frontDoorName'), 'ecommerce-endpoint'), '2024-02-01').hostName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-service-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'static-web-app-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'waf-policy-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "static-web-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "westeurope"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "staticWebAppName": {
            "value": "[variables('resourceNames').staticWebApp]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1570028465679956101"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "westeurope",
              "allowedValues": [
                "westeurope",
                "eastus2",
                "westus2",
                "centralus",
                "eastasia"
              ],
              "metadata": {
                "description": "Azure region for Static Web App (limited availability)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "staticWebAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Static Web App"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('staticWebAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Standard"
              },
              "properties": {
                "stagingEnvironmentPolicy": "Enabled",
                "allowConfigFileUpdates": true,
                "enterpriseGradeCdnStatus": "Disabled"
              }
            }
          ],
          "outputs": {
            "staticWebAppId": {
              "type": "string",
              "metadata": {
                "description": "Static Web App resource ID"
              },
              "value": "[resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName'))]"
            },
            "staticWebAppName": {
              "type": "string",
              "metadata": {
                "description": "Static Web App name"
              },
              "value": "[parameters('staticWebAppName')]"
            },
            "defaultHostName": {
              "type": "string",
              "metadata": {
                "description": "Static Web App default hostname"
              },
              "value": "[reference(resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName')), '2023-12-01').defaultHostname]"
            },
            "deploymentToken": {
              "type": "string",
              "metadata": {
                "description": "Static Web App deployment token"
              },
              "value": "[listSecrets(resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName')), '2023-12-01').properties.apiKey]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "diagnostics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          },
          "appServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-service-deployment'), '2025-04-01').outputs.appServiceName.value]"
          },
          "functionAppName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functions-deployment'), '2025-04-01').outputs.functionAppName.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "sqlServerName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sql-deployment'), '2025-04-01').outputs.sqlServerName.value]"
          },
          "redisCacheName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.redisCacheName.value]"
          },
          "serviceBusName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'service-bus-deployment'), '2025-04-01').outputs.serviceBusName.value]"
          },
          "searchServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'search-deployment'), '2025-04-01').outputs.searchServiceName.value]"
          },
          "frontDoorName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'front-door-deployment'), '2025-04-01').outputs.frontDoorName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17288445009243350818"
            }
          },
          "parameters": {
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID"
              }
            },
            "appServiceName": {
              "type": "string",
              "metadata": {
                "description": "App Service name"
              }
            },
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name"
              }
            },
            "redisCacheName": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache name"
              }
            },
            "serviceBusName": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              }
            },
            "searchServiceName": {
              "type": "string",
              "metadata": {
                "description": "Search service name"
              }
            },
            "frontDoorName": {
              "type": "string",
              "metadata": {
                "description": "Front Door profile name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appServiceName'))]",
              "name": "diag-appservice",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServicePlatformLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('functionAppName'))]",
              "name": "diag-functionapp",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "FunctionAppLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "diag-keyvault",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "AuditEvent",
                    "enabled": true
                  },
                  {
                    "category": "AzurePolicyEvaluationDetails",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Sql/servers/{0}', parameters('sqlServerName'))]",
              "name": "diag-sqlserver",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "SQLSecurityAuditEvents",
                    "enabled": true
                  },
                  {
                    "category": "DevOpsOperationsAudit",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Cache/redis/{0}', parameters('redisCacheName'))]",
              "name": "diag-redis",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "ConnectedClientList",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ServiceBus/namespaces/{0}', parameters('serviceBusName'))]",
              "name": "diag-servicebus",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "OperationalLogs",
                    "enabled": true
                  },
                  {
                    "category": "VNetAndIPFilteringLogs",
                    "enabled": true
                  },
                  {
                    "category": "RuntimeAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "ApplicationMetricsLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('searchServiceName'))]",
              "name": "diag-search",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "OperationLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Cdn/profiles/{0}', parameters('frontDoorName'))]",
              "name": "diag-frontdoor",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "FrontDoorAccessLog",
                    "enabled": true
                  },
                  {
                    "category": "FrontDoorHealthProbeLog",
                    "enabled": true
                  },
                  {
                    "category": "FrontDoorWebApplicationFirewallLog",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-service-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'front-door-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'functions-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'redis-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'search-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'service-bus-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'sql-deployment')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Resource group name"
      },
      "value": "[resourceGroup().name]"
    },
    "vnetId": {
      "type": "string",
      "metadata": {
        "description": "Virtual network resource ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
    },
    "webSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Web subnet resource ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.webSubnetId.value]"
    },
    "dataSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Data subnet resource ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.dataSubnetId.value]"
    },
    "integrationSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Integration subnet resource ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.integrationSubnetId.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "Key Vault URI"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.keyVaultUri.value]"
    },
    "sqlServerFqdn": {
      "type": "string",
      "metadata": {
        "description": "SQL Server FQDN"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sql-deployment'), '2025-04-01').outputs.sqlServerFqdn.value]"
    },
    "redisHostName": {
      "type": "string",
      "metadata": {
        "description": "Redis hostname"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.redisHostName.value]"
    },
    "appServiceHostName": {
      "type": "string",
      "metadata": {
        "description": "App Service default hostname"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-service-deployment'), '2025-04-01').outputs.defaultHostName.value]"
    },
    "functionAppHostName": {
      "type": "string",
      "metadata": {
        "description": "Function App default hostname"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functions-deployment'), '2025-04-01').outputs.defaultHostName.value]"
    },
    "frontDoorHostName": {
      "type": "string",
      "metadata": {
        "description": "Front Door endpoint hostname"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'front-door-deployment'), '2025-04-01').outputs.endpointHostName.value]"
    },
    "staticWebAppHostName": {
      "type": "string",
      "metadata": {
        "description": "Static Web App default hostname"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'static-web-app-deployment'), '2025-04-01').outputs.defaultHostName.value]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Application Insights connection string"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
    }
  }
}